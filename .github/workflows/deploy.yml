name: Deploy to Hostinger

on:
  push:
    branches:
      - main  # Pastikan ini sesuai nama branch utama Anda (main atau master)

jobs:
  FTP-Deploy-Action:
    name: ğŸ‰ Deploy Process
    runs-on: ubuntu-latest
    steps:
    
    # 1. Ambil kode terbaru
    - name: ğŸšš Get latest code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 2. Install NPM dependencies
    - name: ğŸ“¦ Install NPM dependencies
      run: |
        npm ci

    # 3. Build assets
    - name: ğŸ”¨ Build assets
      run: |
        npm run build
        echo "âœ… Build selesai. Memverifikasi folder build..."
        ls -la public/build/ || (echo "âŒ ERROR: Folder public/build tidak ada setelah build!" && exit 1)
        test -f public/build/manifest.json || (echo "âŒ ERROR: manifest.json tidak ada!" && exit 1)
        echo "ğŸ“¦ File di public/build:"
        ls -la public/build/

    # 4. Siapkan folder deploy_laravel (isi yang akan di-upload via FTP)
    - name: ğŸ“ Siapkan folder deploy_laravel
      run: |
        mkdir -p deploy_laravel
        rsync -a \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='.github' \
          --exclude='deploy_laravel' \
          --exclude='storage/logs/*' \
          --exclude='storage/framework/cache/*' \
          --exclude='storage/framework/sessions/*' \
          --exclude='storage/framework/views/*' \
          --exclude='.env' \
          . deploy_laravel/
        echo "âœ… Verifikasi folder build setelah rsync..."
        test -d deploy_laravel/public/build || (echo "âŒ ERROR: Folder deploy_laravel/public/build tidak ada!" && exit 1)
        test -d deploy_laravel/public/build/assets || (echo "âŒ ERROR: Folder deploy_laravel/public/build/assets tidak ada!" && exit 1)
        echo "ğŸ“ Struktur folder build:"
        find deploy_laravel/public/build -type f -name "*.css" -o -name "*.js" | head -10

    # 5. Verifikasi view auth.login dan Vite manifest ada
    - name: âœ… Verifikasi view auth.login dan Vite manifest
      run: |
        test -f deploy_laravel/resources/views/auth/login.blade.php || (echo "ERROR: resources/views/auth/login.blade.php tidak ada di deploy_laravel. Pastikan folder resources ter-deploy." && exit 1)
        test -f deploy_laravel/public/build/manifest.json || (echo "âŒ ERROR: public/build/manifest.json tidak ada. Pastikan npm run build berhasil dan folder build ter-copy." && exit 1)
        echo "âœ… manifest.json ditemukan. Memverifikasi isi manifest..."
        cat deploy_laravel/public/build/manifest.json
        echo ""
        echo "ğŸ“¦ File CSS/JS di deploy_laravel/public/build:"
        ls -la deploy_laravel/public/build/ | grep -E '\.(css|js)$' || echo "âš ï¸  Tidak ada file CSS/JS ditemukan!"

    # 6. Deploy Laravel project ke folder posyandukaranggan (folder akan dibuat otomatis)
    - name: ğŸ“‚ Deploy Laravel to posyandukaranggan
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.IP }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        server-dir: /domains/posyandukaranggan.com/posyandukaranggan/
        port: 21
        protocol: ftp
        timeout: 180000
        local-dir: ./deploy_laravel/
        dangerous-clean-slate: false
        exclude: |
          **/.git*
          **/.git*/**
          **/.github/**
        log-level: verbose