name: Deploy to Hostinger

on:
  push:
    branches:
      - main  # Pastikan ini sesuai nama branch utama Anda (main atau master)

jobs:
  FTP-Deploy-Action:
    name: ğŸ‰ Deploy Process
    runs-on: ubuntu-latest
    steps:
    
    # 1. Ambil kode terbaru
    - name: ğŸšš Get latest code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 2. Setup PHP
    - name: ğŸ”§ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, iconv, json, mbstring, zip

    # 3. Install Composer dependencies
    - name: ğŸ“¦ Install Composer dependencies
      run: |
        composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

    # 4. Install NPM dependencies
    - name: ğŸ“¦ Install NPM dependencies
      run: |
        npm ci

    # 5. Build assets
    - name: ğŸ”¨ Build assets
      run: |
        npm run build

    # 5.4. Storage link (SEBELUM pindah public â†’ public_html, ikuti langkah deploy)
    - name: ğŸ”— Storage link (sebelum pindah isi public)
      run: php artisan storage:link

    # 5.5. Siapkan struktur untuk deployment
    - name: ğŸ“ Prepare deployment structure
      run: |
        # Buat folder untuk Laravel project (tanpa public/)
        mkdir -p deploy_laravel
        # Copy folder dan file yang diperlukan
        [ -d app ] && cp -r app deploy_laravel/
        [ -d bootstrap ] && cp -r bootstrap deploy_laravel/
        [ -d config ] && cp -r config deploy_laravel/
        [ -d database ] && cp -r database deploy_laravel/
        [ -d resources ] && cp -r resources deploy_laravel/
        [ -d routes ] && cp -r routes deploy_laravel/
        [ -d storage ] && cp -r storage deploy_laravel/
        [ -d tests ] && cp -r tests deploy_laravel/
        [ -d vendor ] && cp -r vendor deploy_laravel/
        # Kosongkan compiled views (path absolut dari runner); Laravel akan compile ulang di server
        rm -rf deploy_laravel/storage/framework/views
        mkdir -p deploy_laravel/storage/framework/views
        [ -f artisan ] && cp artisan deploy_laravel/
        [ -f composer.json ] && cp composer.json deploy_laravel/
        [ -f composer.lock ] && cp composer.lock deploy_laravel/
        [ -f package.json ] && cp package.json deploy_laravel/
        [ -f package-lock.json ] && cp package-lock.json deploy_laravel/
        [ -f phpunit.xml ] && cp phpunit.xml deploy_laravel/
        [ -f tailwind.config.js ] && cp tailwind.config.js deploy_laravel/
        [ -f vite.config.js ] && cp vite.config.js deploy_laravel/
        [ -f postcss.config.js ] && cp postcss.config.js deploy_laravel/
        [ -f .editorconfig ] && cp .editorconfig deploy_laravel/
        [ -f .gitattributes ] && cp .gitattributes deploy_laravel/
        [ -f .gitignore ] && cp .gitignore deploy_laravel/
        [ -f .htaccess ] && cp .htaccess deploy_laravel/
        [ -f env.hostinger.example ] && cp env.hostinger.example deploy_laravel/
        [ -f HOSTINGER_SETUP.md ] && cp HOSTINGER_SETUP.md deploy_laravel/
        
        # Buat folder untuk public_html & copy isi public/ (bukan folder Laravel)
        # NOTE: Jalanin storage:link dulu sebelum pindah public â†’ public_html.
        mkdir -p deploy_public_html
        rsync -a --exclude='storage' public/ deploy_public_html/
        [ -f public/.htaccess ] && cp public/.htaccess deploy_public_html/
        # Symlink storage di public_html â†’ posyandukaranggan/storage/app/public
        ln -sf ../posyandukaranggan/storage/app/public deploy_public_html/storage
        # Update index.php path (dari __DIR__.'/../ ke __DIR__.'/../posyandukaranggan/)
        sed -i "s|__DIR__.'/../|__DIR__.'/../posyandukaranggan/|g" deploy_public_html/index.php
        sed -i "s|__DIR__.\"/../|__DIR__.\"/../posyandukaranggan/|g" deploy_public_html/index.php

    # 5.6. Verifikasi view auth.login ada (cegah "View [auth.login] not found")
    - name: âœ… Verifikasi view auth.login
      run: |
        test -f deploy_laravel/resources/views/auth/login.blade.php || (echo "ERROR: resources/views/auth/login.blade.php tidak ada di deploy_laravel. Pastikan folder resources ter-deploy." && exit 1)

    # 6. Deploy Laravel project ke folder posyandukaranggan (folder akan dibuat otomatis)
    - name: ğŸ“‚ Deploy Laravel to posyandukaranggan
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.IP }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        server-dir: /domains/posyandukaranggan.com/posyandukaranggan/
        port: 21
        protocol: ftp
        timeout: 180000
        local-dir: ./deploy_laravel/
        exclude: |
          **/.git*
          **/.git*/**
          **/.github/**

    # 6.5. Pindahkan .env dari public_html ke posyandukaranggan (sebelum membersihkan public_html)
    - name: ğŸ”„ Move .env from public_html to posyandukaranggan
      run: |
        sudo apt-get update && sudo apt-get install -y lftp
        lftp -c "
        set ftp:ssl-allow no;
        open -u ${{ secrets.USERNAME }},${{ secrets.PASSWORD }} ftp://${{ secrets.IP }}:21;
        cd /domains/posyandukaranggan.com/public_html;
        get .env -o /tmp/.env || echo '.env tidak ditemukan di public_html, skip...';
        cd /domains/posyandukaranggan.com/posyandukaranggan;
        put /tmp/.env -o .env || echo 'Gagal upload .env, pastikan folder posyandukaranggan sudah ada';
        cd /domains/posyandukaranggan.com/public_html;
        rm .env || echo 'Gagal hapus .env dari public_html';
        quit;
        " || echo "Langkah ini akan di-skip jika .env tidak ada atau sudah dipindahkan"

    # 7. Deploy isi public/ ke public_html/ (bersihkan dulu karena sudah ada isinya)
    - name: ğŸ“‚ Deploy public to public_html
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.IP }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        server-dir: /domains/posyandukaranggan.com/public_html/
        port: 21
        protocol: ftp
        timeout: 180000
        local-dir: ./deploy_public_html/
        dangerous-clean-slate: true
        exclude: |
          **/.git*
          **/.git*/**
          **/.github/**
          **/vendor/**
