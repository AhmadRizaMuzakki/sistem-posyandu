name: ğŸš€ Multi-Stage Deploy (Staging & Production)

on:
  push:
    branches:
      - main      # Production
      - staging   # Staging (Buat branch ini jika belum ada)

# Mencegah deploy bertumpuk jika ada push beruntun
concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ----------------------------------------------------------------------
  # JOB 1: BUILD (Berjalan sama untuk Staging & Production)
  # ----------------------------------------------------------------------
  build:
    name: ğŸ“¦ Build Assets & Vendor
    runs-on: ubuntu-latest
    steps:
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Cukup ambil history sedikit untuk diff

      - name: ğŸ“¦ Setup PHP (Faster Composer)
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2' # Sesuaikan versi PHP Hostinger Anda
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, json
          coverage: none

      - name: ğŸ“¦ Install NPM dependencies
        run: npm ci

      - name: ğŸ”¨ Build Assets (Vite)
        run: npm run build

      - name: ğŸ¼ Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader --prefer-dist --no-interaction --no-progress

      # Kita siapkan folder artefak bersih di sini agar siap upload
      - name: ğŸ“ Prepare Deploy Artifact
        run: |
          mkdir -p deploy_package
          # Copy semua file project ke folder deploy_package
          rsync -a \
          --exclude="vendor" \
          --exclude="**/vendor/**" \
          --exclude="node_modules" \
          --exclude=".git" \
          --exclude=".github" \
          --exclude=".env" \
          . deploy_package/

          echo "âœ… Artifact siap. Mengecek manifest..."
          ls -la deploy_package/public/build/

      # Simpan hasil build agar bisa dipakai di job deploy berikutnya
      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-build
          path: deploy_package/
          retention-days: 1

  # ----------------------------------------------------------------------
  # JOB 2: DEPLOY STAGING (Hanya jalan jika branch = staging)
  # ----------------------------------------------------------------------
  deploy-staging:
    name: ğŸš§ Deploy to Staging
    needs: build
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    environment: 
      name: staging
      url: https://staging.posyandukaranggan.com # Ganti URL Staging Anda
    steps:
      - name: ğŸ“¥ Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-build
          path: . 

      - name: ğŸ“‚ FTP Sync (Changes Only)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.IP }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          # GANTI path ini sesuai folder staging di Hostinger Anda
          server-dir: /domains/posyandukaranggan.com/public_html/staging/ 
          log-level: standard
          # PENTING: State file memastikan hanya file berubah yang diupload
          state-name: .ftp-deploy-sync-state-staging.json 

  # ----------------------------------------------------------------------
  # JOB 3: DEPLOY PRODUCTION (Hanya jalan jika branch = main)
  # ----------------------------------------------------------------------
  deploy-production:
    name: ğŸ‰ Deploy to Production
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: https://posyandukaranggan.com
    steps:
      - name: ğŸ“¥ Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-build
          path: .

      - name: ğŸ“‚ FTP Sync (Changes Only)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.IP }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          # Path Production Anda
          server-dir: /domains/posyandukaranggan.com/posyandukaranggan/ 
          log-level: verbose
          # PENTING: Ini kuncinya. Action ini akan mengecek file ini di server.
          # Jika file lokal == file server (hash-nya sama), dia SKIP upload.
          state-name: .ftp-deploy-sync-state.json